<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Administration - Alchemy Barcode Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">Tenant Administration</h1>
        
        <div class="row mb-5">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Tenants</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Display Name</th>
                                    <th>Actual Tenant Name</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tenant_id, tenant in tenants.items() %}
                                <tr>
                                    <td>{{ tenant_id }}</td>
                                    <td>{{ tenant.display_name }}</td>
                                    <td>{{ tenant.tenant_name }}</td>
                                    <td>{{ tenant.description }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary edit-tenant-btn" 
                                                    data-tenant-id="{{ tenant_id }}" 
                                                    data-tenant-name="{{ tenant.tenant_name }}"
                                                    data-display-name="{{ tenant.display_name }}"
                                                    data-description="{{ tenant.description }}"
                                                    data-button-class="{{ tenant.button_class }}"
                                                    data-env-token-var="{{ tenant.env_token_var }}"
                                                    data-use-custom-urls="{{ tenant.use_custom_urls|lower }}">
                                                Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-success get-token-btn"
                                                    data-tenant-id="{{ tenant_id }}"
                                                    data-tenant-name="{{ tenant.tenant_name }}">
                                                Get Token
                                            </button>
                                            {% if tenant_id != default_tenant %}
                                            <button class="btn btn-sm btn-outline-danger delete-tenant-btn" 
                                                    data-tenant-id="{{ tenant_id }}"
                                                    data-display-name="{{ tenant.display_name }}">
                                                Delete
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 id="form-title">Add New Tenant</h5>
                    </div>
                    <div class="card-body">
                        <form id="tenant-form">
                            <input type="hidden" id="form-mode" value="add"> <!-- add or edit mode -->
                            <input type="hidden" id="edit-tenant-id" value=""> <!-- for edit mode -->
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Tenant ID</label>
                                    <input type="text" id="tenant_id" name="tenant_id" class="form-control" required>
                                    <div class="form-text">Internal ID for the tenant (e.g., tenant1)</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Actual Tenant Name</label>
                                    <input type="text" id="tenant_name" name="tenant_name" class="form-control" required>
                                    <div class="form-text">Actual tenant name in Alchemy</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Display Name</label>
                                    <input type="text" id="display_name" name="display_name" class="form-control" required>
                                    <div class="form-text">Name shown to users</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Description</label>
                                    <input type="text" id="description" name="description" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Button Class</label>
                                    <select id="button_class" name="button_class" class="form-select">
                                        <option value="primary">Primary</option>
                                        <option value="secondary">Secondary</option>
                                        <option value="success">Success</option>
                                        <option value="info">Info</option>
                                        <option value="warning">Warning</option>
                                        <option value="danger">Danger</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Environment Variable</label>
                                    <input type="text" id="env_token_var" name="env_token_var" class="form-control" required>
                                    <div class="form-text">Env var for refresh token</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="use_custom_urls" id="use_custom_urls">
                                    <label class="form-check-label" for="use_custom_urls">
                                        Use Custom URLs
                                    </label>
                                </div>
                            </div>
                            
                            <div id="custom_urls_section" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Refresh URL</label>
                                        <input type="text" id="refresh_url" name="refresh_url" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">API URL</label>
                                        <input type="text" id="api_url" name="api_url" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Filter URL</label>
                                        <input type="text" id="filter_url" name="filter_url" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Find Records URL</label>
                                        <input type="text" id="find_records_url" name="find_records_url" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Base URL</label>
                                        <input type="text" id="base_url" name="base_url" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" id="submit-btn" class="btn btn-primary">Add Tenant</button>
                                <button type="button" id="cancel-btn" class="btn btn-secondary" style="display:none;">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between">
                    <button id="reload-config-btn" class="btn btn-info">Reload Config</button>
                    <a href="/" class="btn btn-secondary">Back to Home</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the tenant "<span id="delete-tenant-name"></span>"?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Token Modal -->
    <div class="modal fade" id="tokenModal" tabindex="-1" aria-labelledby="tokenModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tokenModalLabel">Get Refresh Token</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="token-credentials-form">
                        <div class="alert alert-info">
                            Enter your Alchemy credentials to get a refresh token for tenant: <strong id="token-tenant-name"></strong>
                        </div>
                        <div class="mb-3">
                            <label for="token-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="token-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="token-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="token-password" required>
                        </div>
                    </div>
                    
                    <div id="token-result" style="display:none;">
                        <div class="alert alert-success mb-3">
                            Token successfully retrieved for tenant: <strong id="token-result-tenant-name"></strong>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Refresh Token</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="refresh-token-value" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copy-token-btn">
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Access Token</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="access-token-value" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copy-access-token-btn">
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Environment Variable Command</label>
                            <div class="alert alert-dark" id="env-var-command">
                                export TOKEN_VAR="token_value"
                            </div>
                        </div>
                    </div>
                    
                    <div id="token-error" class="alert alert-danger" style="display:none;">
                        Error retrieving token. Please check your credentials and try again.
                    </div>
                    
                    <div id="token-loading" style="display:none;">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <p class="text-center mt-2">Retrieving token...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="token-close-btn">Close</button>
                    <button type="button" class="btn btn-primary" id="token-submit-btn">Get Token</button>
                    <button type="button" class="btn btn-secondary" id="token-reset-btn" style="display:none;">Get Another Token</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables
            const tenantForm = document.getElementById('tenant-form');
            const formMode = document.getElementById('form-mode');
            const editTenantId = document.getElementById('edit-tenant-id');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const tenantIdInput = document.getElementById('tenant_id');
            
            // Bootstrap modal setup
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const tokenModal = new bootstrap.Modal(document.getElementById('tokenModal'));
            let tenantToDelete = null;
            let currentTokenTenant = null;
            
            // Toggle custom URLs section
            const useCustomUrlsCheckbox = document.getElementById('use_custom_urls');
            const customUrlsSection = document.getElementById('custom_urls_section');
            
            useCustomUrlsCheckbox.addEventListener('change', function() {
                customUrlsSection.style.display = this.checked ? 'block' : 'none';
            });
            
            // Edit tenant button click
            const editButtons = document.querySelectorAll('.edit-tenant-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Switch form to edit mode
                    formMode.value = 'edit';
                    editTenantId.value = this.dataset.tenantId;
                    formTitle.textContent = 'Edit Tenant: ' + this.dataset.displayName;
                    submitBtn.textContent = 'Update Tenant';
                    cancelBtn.style.display = 'inline-block';
                    
                    // Populate form with tenant data
                    tenantIdInput.value = this.dataset.tenantId;
                    tenantIdInput.readOnly = true; // Can't change tenant ID when editing
                    
                    document.getElementById('tenant_name').value = this.dataset.tenantName;
                    document.getElementById('display_name').value = this.dataset.displayName;
                    document.getElementById('description').value = this.dataset.description;
                    document.getElementById('button_class').value = this.dataset.buttonClass;
                    document.getElementById('env_token_var').value = this.dataset.envTokenVar;
                    
                    const useCustomUrls = this.dataset.useCustomUrls === 'true';
                    useCustomUrlsCheckbox.checked = useCustomUrls;
                    customUrlsSection.style.display = useCustomUrls ? 'block' : 'none';
                    
                    // TODO: If custom URLs are used, we need to fetch them from the server
                    // since they're not included in the data attributes
                    if (useCustomUrls) {
                        // This could be expanded to fetch custom URLs via AJAX if needed
                        console.log('Custom URLs are enabled, but not fetched yet');
                    }
                    
                    // Scroll to the form
                    window.scrollTo({
                        top: tenantForm.offsetTop - 100,
                        behavior: 'smooth'
                    });
                });
            });
            
            // Cancel button click
            cancelBtn.addEventListener('click', function() {
                resetForm();
            });
            
            // Delete tenant button click
            const deleteButtons = document.querySelectorAll('.delete-tenant-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tenantToDelete = this.dataset.tenantId;
                    document.getElementById('delete-tenant-name').textContent = this.dataset.displayName;
                    deleteModal.show();
                });
            });
            
            // Get token button click
            const getTokenButtons = document.querySelectorAll('.get-token-btn');
            getTokenButtons.forEach(button => {
                button.addEventListener('click', function() {
                    currentTokenTenant = {
                        id: this.dataset.tenantId,
                        name: this.dataset.tenantName
                    };
                    
                    // Reset the token modal
                    resetTokenModal();
                    
                    // Set the tenant name in the modal
                    document.getElementById('token-tenant-name').textContent = currentTokenTenant.name;
                    
                    // Show the modal
                    tokenModal.show();
                });
            });
            
            // Token submit button click
            document.getElementById('token-submit-btn').addEventListener('click', function() {
                const email = document.getElementById('token-email').value;
                const password = document.getElementById('token-password').value;
                
                if (!email || !password) {
                    alert('Please enter your email and password');
                    return;
                }
                
                getRefreshToken(email, password);
            });
            
            // Token reset button click
            document.getElementById('token-reset-btn').addEventListener('click', function() {
                resetTokenModal();
            });
            
            // Copy token buttons
            document.getElementById('copy-token-btn').addEventListener('click', function() {
                copyToClipboard('refresh-token-value');
            });
            
            document.getElementById('copy-access-token-btn').addEventListener('click', function() {
                copyToClipboard('access-token-value');
            });
            
            // Confirm delete button click
            document.getElementById('confirm-delete-btn').addEventListener('click', function() {
                if (tenantToDelete) {
                    deleteTenant(tenantToDelete);
                }
            });
            
            // Handle form submission
            tenantForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(tenantForm);
                
                if (formMode.value === 'edit') {
                    // Update existing tenant
                    fetch(`/admin/update-tenant/${editTenantId.value}`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
                } else {
                    // Add new tenant
                    fetch('/admin/add-tenant', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
                }
            });
            
            // Delete tenant function
            function deleteTenant(tenantId) {
                fetch(`/admin/delete-tenant/${tenantId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    deleteModal.hide();
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    deleteModal.hide();
                    alert('Error: ' + error.message);
                });
            }
            
            // Get refresh token function
            function getRefreshToken(email, password) {
                // Show loading indicator
                document.getElementById('token-credentials-form').style.display = 'none';
                document.getElementById('token-loading').style.display = 'block';
                document.getElementById('token-submit-btn').style.display = 'none';
                document.getElementById('token-error').style.display = 'none';
                document.getElementById('token-result').style.display = 'none';
                
                // Make API request
                fetch('https://core-production.alchemy.cloud/core/api/v2/sign-in', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Authentication failed. Please check your credentials.');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading indicator
                    document.getElementById('token-loading').style.display = 'none';
                    
                    // Find the token for the current tenant
                    const tenantToken = data.tokens ? data.tokens.find(token => 
                        token.tenant.toLowerCase() === currentTokenTenant.name.toLowerCase()
                    ) : null;
                    
                    if (!tenantToken) {
                        throw new Error(`No token found for tenant: ${currentTokenTenant.name}`);
                    }
                    
                    // Display token
                    document.getElementById('token-result').style.display = 'block';
                    document.getElementById('token-result-tenant-name').textContent = tenantToken.tenant;
                    document.getElementById('refresh-token-value').value = tenantToken.refreshToken;
                    document.getElementById('access-token-value').value = tenantToken.accessToken;
                    
                    // Generate env var command
                    const envVarElement = document.getElementById('env-var-command');
                    const envVarName = document.querySelector(`[data-tenant-id="${currentTokenTenant.id}"]`).dataset.envTokenVar;
                    envVarElement.textContent = `export ${envVarName}="${tenantToken.refreshToken}"`;
                    
                    // Show reset button
                    document.getElementById('token-reset-btn').style.display = 'inline-block';
                })
                .catch(error => {
                    console.error('Error getting token:', error);
                    
                    // Hide loading indicator
                    document.getElementById('token-loading').style.display = 'none';
                    
                    // Show error message
                    const errorElement = document.getElementById('token-error');
                    errorElement.style.display = 'block';
                    errorElement.textContent = error.message || 'Error retrieving token. Please check your credentials and try again.';
                    
                    // Show form again
                    document.getElementById('token-credentials-form').style.display = 'block';
                    document.getElementById('token-submit-btn').style.display = 'inline-block';
                });
            }
            
            // Copy to clipboard function
            function copyToClipboard(elementId) {
                const element = document.getElementById(elementId);
                element.select();
                document.execCommand('copy');
                
                // Show feedback
                const originalButtonText = event.target.textContent;
                event.target.textContent = 'Copied!';
                setTimeout(() => {
                    event.target.textContent = originalButtonText;
                }, 2000);
            }
            
            // Reload config button click
            document.getElementById('reload-config-btn').addEventListener('click', function() {
                fetch('/admin/reload-config', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            });
            
            // Reset form to add mode
            function resetForm() {
                formMode.value = 'add';
                editTenantId.value = '';
                formTitle.textContent = 'Add New Tenant';
                submitBtn.textContent = 'Add Tenant';
                cancelBtn.style.display = 'none';
                
                tenantIdInput.readOnly = false;
                tenantForm.reset();
                customUrlsSection.style.display = 'none';
            }
            
            // Reset token modal
            function resetTokenModal() {
                document.getElementById('token-credentials-form').style.display = 'block';
                document.getElementById('token-loading').style.display = 'none';
                document.getElementById('token-error').style.display = 'none';
                document.getElementById('token-result').style.display = 'none';
                document.getElementById('token-submit-btn').style.display = 'inline-block';
                document.getElementById('token-reset-btn').style.display = 'none';
                
                // Clear form fields
                document.getElementById('token-email').value = '';
                document.getElementById('token-password').value = '';
            }
        });
    </script>
</body>
</html>
