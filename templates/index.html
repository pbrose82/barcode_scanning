{% extends "layout.html" %}

{% block title %}Alchemy Barcode Scanner{% endblock %}
{% set active_page = 'scanner' %}

{% block extra_css %}
<style>
  /* Background */
  html, body { 
    height: 100%; 
    background-color: #F9FAFB; /* Light gray background for the page */
  }
  .page-content{
    min-height:100vh;
  }

  /* Layout */
  .scanner-content{ padding:56px; max-width:900px; margin:0 auto; }
  .scanner-main{
    background:#fff; border-radius:12px; padding:40px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
  }

  /* Type */
  .page-title{ font-size:28px; color:#383F45; font-weight:600; margin-bottom:20px; }
  .instruction-text{ font-size:14px; color:#6B7280; line-height:1.6; margin-bottom:40px; }
  .section-title{ font-size:24px; color:#383F45; font-weight:600; margin-bottom:20px; padding-top:56px; }
  .section-title:first-of-type{ padding-top:0; }
  .form-label{ font-size:12px; font-weight:700; color:#424B52; margin-bottom:8px; display:block; text-transform:uppercase; }

  /* Inputs */
  .barcode-input-group{ display:flex; gap:10px; margin-bottom:8px; }
  .barcode-input{
    flex:1; padding:10px 16px; font-size:14px;
    border:1px solid #E1E4E8; border-radius:6px; transition:border-color .2s;
  }
  .barcode-input:focus{ outline:none; border-color:#0066FF; }

  .form-select{
    width: 100%; padding: 10px 16px; font-size: 14px;
    border: 1px solid #E1E4E8; border-radius: 6px; background-color: #fff;
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  .form-select:disabled { background-color:#F3F4F6; cursor:not-allowed; }

  /* Buttons */
  .btn{ border:none; border-radius:6px; padding:12px 24px; font-size:14px; font-weight:700; text-transform:uppercase; cursor:pointer; transition:background-color .2s, opacity .2s, border-color .2s; }
  .btn-primary{ background:#0066FF; color:#fff; }
  .btn-primary:hover:not(:disabled){ background:#0052CC; }
  .btn-primary:disabled{ background:#BFCFEF; cursor:not-allowed; opacity:.9; }
  .btn-outline{ background:transparent; color:#0066FF; border:1px solid #0066FF; }
  .btn-outline:hover{ background:#F0F7FF; }

  /* Table container */
  .scanned-table-container{
    background:#fff; border:1px solid #E5E7EB; border-radius:8px; margin-top:20px; 
    overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,.04);
  }

  /* Table */
  .scanned-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  .scanned-table thead{ background:#F9FAFB; }
  .scanned-table th, .scanned-table td { border-bottom:1px solid #E5E7EB; }
  .scanned-table th{
    text-align:left; font-size:12px; font-weight:700; color:#424B52;
    text-transform:uppercase; letter-spacing:.02em; padding:14px 20px;
  }
  .scanned-table th.col-select, .scanned-table td.td-select { width:56px; text-align:center; padding: 12px; }
  
  /* UPDATED: Aligns checkbox and bulk actions in header */
  .scanned-table th.col-select { 
    display: flex; align-items: center; gap: 16px; width: auto; 
  }
  
  .scanned-table td{
    padding:12px 20px; font-size:14px; color:#374151; vertical-align:middle;
  }
  .scanned-table tbody tr:last-child td{ border-bottom:none; }
  
  /* Custom Checkbox */
  .checkbox-input {
    appearance: none; -webkit-appearance: none;
    width: 18px; height: 18px;
    border: 1.5px solid #D1D5DB; border-radius: 4px;
    background-color: #fff; cursor: pointer;
    display: inline-block; position: relative; vertical-align: middle;
  }
  .checkbox-input:checked { background-color: #0066FF; border-color: #0066FF; }
  .checkbox-input:checked::after {
    content: ''; position: absolute; left: 5px; top: 2px;
    width: 5px; height: 10px; border: solid white;
    border-width: 0 2px 2px 0; transform: rotate(45deg);
  }

  /* UPDATED: Bulk actions container (replaces popup) */
  .bulk-actions {
    display: flex; /* Toggled by JS */
    align-items: center;
    gap: 8px;
  }
  .action-btn {
    border: none; background: transparent; cursor: pointer;
    padding: 4px; display: flex; align-items: center; justify-content: center;
  }
  .action-btn:hover svg { fill: #374151; }
  .action-btn svg { width: 18px; height: 18px; fill: #9CA3AF; transition: fill .2s; }
  .action-divider { width: 1px; height: 18px; background-color: #E5E7EB; }

  /* Empty state */
  .empty-state{ text-align:center; padding:60px 20px; }
  .barcode-icon{ font-family:monospace; font-size:36px; color:#D1D5DB; margin-bottom:16px; letter-spacing:3px; font-weight:100; }
  .empty-state-title{ font-size:15px; font-weight:600; color:#6B7280; margin-bottom:8px; }
  .empty-state-text{ font-size:14px; color:#6B7280; }

  /* Actions row */
  .button-group{ display:flex; gap:16px; margin-top:56px; }
  
  /* Other styles remain the same */
</style>
{% endblock %}

{% block content %}
<div class="page-content">
  <div class="scanner-content">
    <div class="scanner-main">
      <h1 class="page-title">Barcode Scanning</h1>

      <p class="instruction-text">
        Before scanning, make sure the input field is active so the barcode is entered correctly. In case the scanner doesnâ€™t respond or fails to read the code, you can simply type the barcode manually instead. There's no limit to how many barcodes you can scan, so feel free to continue as needed.
      </p>

      <h2 class="section-title">Barcode Overview</h2>

      <div class="form-group">
        <label class="form-label" for="barcode-input">Scan or Enter Barcode</label>
        <div class="barcode-input-group">
          <input type="text" id="barcode-input" class="barcode-input" placeholder="Enter barcode..." autofocus>
          <button id="add-barcode" class="btn btn-primary">Add</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Scanned Barcodes</label>
        <div class="scanned-table-container">
          <table class="scanned-table">
            <thead>
              <tr>
                <th class="col-select">
                    <input type="checkbox" id="select-all-checkbox" class="checkbox-input">
                    <div id="bulk-actions" style="display: none;">
                        <button class="action-btn" title="Add Action">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        </button>
                        <button id="delete-selected-btn" class="action-btn" title="Delete Selected">
                            <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </th>
                <th class="col-name">Name</th>
              </tr>
            </thead>
            <tbody id="scanned-items">
              </tbody>
          </table>
        </div>
      </div>

      <h2 class="section-title">Location</h2>
      <div class="form-group">
        <label class="form-label" for="location-select">Location</label>
        <select class="form-select" id="location-select">
          <option value="">-- Please Select --</option>
        </select>
      </div>
      <div class="form-group" style="margin-top:20px;">
        <label class="form-label" for="sublocation-select">Sublocation</label>
        <select class="form-select" id="sublocation-select" disabled>
          <option value="">-- Please Select --</option>
        </select>
      </div>

      <div class="button-group">
        <div id="update-wrapper" class="has-tooltip" data-tooltip="">
          <button id="update-button" class="btn btn-primary" disabled>Update Location</button>
        </div>
        <button id="reset-button" class="btn btn-outline">Reset</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const barcodeInput = document.getElementById('barcode-input');
  const addButton = document.getElementById('add-barcode');
  const scannedItems = document.getElementById('scanned-items');
  const updateWrapper = document.getElementById('update-wrapper');
  const updateButton = document.getElementById('update-button');
  const resetButton = document.getElementById('reset-button');
  const locationSelect = document.getElementById('location-select');
  const sublocationSelect = document.getElementById('sublocation-select');

  // UPDATED: Selection elements
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const bulkActions = document.getElementById('bulk-actions');
  const deleteSelectedBtn = document.getElementById('delete-selected-btn');

  let scannedBarcodes = [];
  let isProcessing = false;

  function showEmptyState() {
    scannedItems.innerHTML = `
      <tr id="empty-state">
        <td colspan="2" class="empty-state">
          <div class="barcode-icon">||||</div>
          <div class="empty-state-title">No scanned samples</div>
          <div class="empty-state-text">This table will automatically populate with samples as they are scanned or entered manually in the input field above.</div>
        </td>
      </tr>`;
  }

  function refreshUpdateState() {
    const enabled = scannedBarcodes.length > 0 && !!locationSelect.value && !isProcessing;
    updateButton.disabled = !enabled;
    // tooltip logic can be added here if needed
  }
  
  // UPDATED: Logic to show/hide bulk actions in the header
  function updateSelectionState() {
    const checkedCheckboxes = scannedItems.querySelectorAll('.row-checkbox:checked');
    const selectedCount = checkedCheckboxes.length;

    if (selectedCount > 0) {
        bulkActions.style.display = 'flex';
    } else {
        bulkActions.style.display = 'none';
    }
  }

  function rowTemplate(barcode){
    return `
      <tr data-barcode="${barcode}">
        <td class="td-select">
          <input type="checkbox" class="row-checkbox checkbox-input" data-barcode="${barcode}">
        </td>
        <td>${barcode}</td>
      </tr>`;
  }
  
  function addBarcode() {
    const barcode = barcodeInput.value.trim();
    if (!barcode || scannedBarcodes.includes(barcode)) {
        barcodeInput.value = '';
        return;
    };

    scannedBarcodes.push(barcode);
    document.getElementById('empty-state')?.remove();
    scannedItems.insertAdjacentHTML('beforeend', rowTemplate(barcode));

    barcodeInput.value = '';
    barcodeInput.focus();
    refreshUpdateState();
  }
  
  function deleteSelected() {
    if (isProcessing) return;
    const checkedCheckboxes = scannedItems.querySelectorAll('.row-checkbox:checked');
    
    checkedCheckboxes.forEach(checkbox => {
        const barcode = checkbox.dataset.barcode;
        const rowEl = checkbox.closest('tr');
        
        const idx = scannedBarcodes.indexOf(barcode);
        if (idx > -1) scannedBarcodes.splice(idx, 1);
        rowEl?.remove();
    });

    if (scannedBarcodes.length === 0) showEmptyState();
    
    updateSelectionState(); // Hides bulk actions
    refreshUpdateState();
  }

  // --- Event Listeners ---
  addButton.addEventListener('click', addBarcode);
  barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') addBarcode(); });
  
  locationSelect.addEventListener('change', () => {
    sublocationSelect.disabled = !locationSelect.value;
    refreshUpdateState();
  });
  
  resetButton.addEventListener('click', () => {
    if (isProcessing) return;
    scannedBarcodes = [];
    showEmptyState();
    locationSelect.value = '';
    sublocationSelect.value = '';
    sublocationSelect.disabled = true;
    updateSelectionState();
    refreshUpdateState();
    barcodeInput.focus();
  });
  
  // Selection logic listeners
  scannedItems.addEventListener('change', e => {
    if (e.target.classList.contains('row-checkbox')) {
        updateSelectionState();
    }
  });

  selectAllCheckbox.addEventListener('click', () => {
    scannedItems.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
    updateSelectionState();
  });
  
  deleteSelectedBtn.addEventListener('click', deleteSelected);

  // --- Initialization ---
  showEmptyState();
  refreshUpdateState();
  barcodeInput.focus();
});
</script>
{% endblock %}
