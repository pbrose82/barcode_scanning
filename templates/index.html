{% extends "layout.html" %}

{% block title %}Alchemy Barcode Scanner{% endblock %}
{% set active_page = 'scanner' %}

{% block extra_css %}
<style>
  /* Background */
  html, body { height: 100%; }
  .page-content{
    min-height:100vh;
    background:linear-gradient(135deg,#E4D0FF 0%,#D0FF5F 100%);
    border-bottom:1px solid #F9F7FA;
  }

  /* Layout */
  .scanner-content{ padding:56px; max-width:900px; margin:0 auto; }
  .scanner-main{
    background:#fff; border-radius:12px; padding:40px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
  }

  /* Type */
  .page-title{ font-size:28px; color:#383F45; font-weight:600; margin-bottom:20px; }
  .instruction-text{ font-size:14px; color:#6B7280; line-height:1.6; margin-bottom:40px; }
  .section-title{ font-size:24px; color:#383F45; font-weight:600; margin-bottom:20px; padding-top:56px; }
  .section-title:first-of-type{ padding-top:0; }
  .form-label{ font-size:12px; font-weight:700; color:#424B52; margin-bottom:8px; display:block; }

  /* Inputs */
  .barcode-input-group{ display:flex; gap:10px; margin-bottom:8px; }
  .barcode-input{
    flex:1; padding:10px 16px; font-size:14px;
    border:1px solid #E1E4E8; border-radius:6px; transition:border-color .2s;
  }
  .barcode-input:focus{ outline:none; border-color:#0066FF; }

  /* Buttons */
  .btn{ border:none; border-radius:6px; padding:12px 24px; font-size:14px; font-weight:700; text-transform:uppercase; cursor:pointer; transition:background-color .2s, opacity .2s, border-color .2s; }
  .btn-primary{ background:#0066FF; color:#fff; }
  .btn-primary:hover:not(:disabled){ background:#0052CC; }
  .btn-primary:disabled{ background:#BFCFEF; cursor:not-allowed; opacity:.9; }
  .btn-outline{ background:#fff; color:#0066FF; border:1px solid #0066FF; }
  .btn-outline:hover{ background:#F0F7FF; }

  /* Table container (no outer border) */
  .scanned-table-container{
    background:#fff; border:none; border-radius:8px; margin-top:20px; overflow:hidden;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
  }

  /* Table look */
  .scanned-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  .scanned-table thead{ background:#F9FAFB; border-bottom:1px solid #E5E7EB; }
  .scanned-table th{
    text-align:left; font-size:12px; font-weight:700; color:#424B52;
    text-transform:uppercase; letter-spacing:.02em; padding:14px 20px;
  }
  .scanned-table th.col-select{ width:56px; padding-left:0; padding-right:0; text-align:center; }
  .scanned-table th.col-name{ padding-left:20px; }

  .scanned-table td{
    padding:12px 20px; font-size:14px; color:#374151; border-bottom:1px solid #F3F4F6;
    vertical-align:middle;
  }
  .scanned-table tbody tr:last-child td{ border-bottom:none; }
  .scanned-table .td-select{ width:56px; padding:12px 0; text-align:center; }

  /* Checkbox + under-cell actions (like your screenshot) */
  .cell-with-controls{
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .checkbox{
    width:18px; height:18px; border:2px solid #D1D5DB; border-radius:3px; display:block;
  }
  .cell-actions{ display:flex; gap:6px; }
  .action-btn{
    border:1px solid #D1D5DB; background:#fff; border-radius:6px;
    padding:2px 8px; font-size:12px; line-height:1.2; color:#6B7280; cursor:pointer;
  }
  .action-btn:hover{ border-color:#B6BCC3; }

  /* Optional: hide actions until hover (comment out if you want always visible) */
  .scanned-table tbody tr .cell-actions{ opacity:.0; transition:opacity .15s; pointer-events:none; }
  .scanned-table tbody tr:hover .cell-actions{ opacity:1; pointer-events:auto; }

  /* Empty state */
  .empty-state{ text-align:center; padding:60px 20px; background:#F9FAFB; }
  .barcode-icon{ font-family:monospace; font-size:36px; color:#D1D5DB; margin-bottom:16px; letter-spacing:3px; font-weight:100; }
  .empty-state-title{ font-size:15px; font-weight:600; color:#6B7280; margin-bottom:8px; }
  .empty-state-text{ font-size:14px; color:#6B7280; }

  /* Actions row */
  .button-group{ display:flex; gap:16px; margin-top:56px; }
  .has-tooltip{ position:relative; display:inline-block; }
  .has-tooltip[data-tooltip]:hover::after{
    content:attr(data-tooltip); position:absolute; left:0; top:calc(100% + 8px);
    background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:4px; white-space:nowrap; box-shadow:0 2px 6px rgba(0,0,0,.15); z-index:10;
  }
  .has-tooltip[data-tooltip]:hover::before{
    content:""; position:absolute; left:10px; top:100%; border:6px solid transparent; border-top-color:#111827;
  }

  /* Processing / results */
  .processing-status{ background:#EFF6FF; border:1px solid #BFDBFE; border-radius:6px; padding:16px; margin-top:20px; display:none; }
  .processing-content{ display:flex; align-items:center; gap:12px; }
  .spinner{ width:20px; height:20px; border:2px solid #E0E7FF; border-top-color:#0066FF; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .progress-bar-container{ margin-top:12px; height:8px; background:#E0E7FF; border-radius:4px; overflow:hidden; }
  .progress-bar{ height:100%; background:#0066FF; width:0%; transition:width .3s ease; }

  .result-box{ background:#F0FDF4; border:1px solid #86EFAC; border-radius:6px; padding:20px; margin-top:20px; display:none; }
  .result-box h5{ color:#166534; margin-bottom:12px; font-size:16px; }

  /* Responsive */
  @media (max-width:1024px){ .scanner-content{ padding:24px; } }
  @media (max-width:640px){
    .scanner-main{ padding:24px; }
    .page-title{ font-size:24px; }
    .section-title{ font-size:20px; padding-top:40px; }
    .button-group{ flex-direction:column; }
    .button-group .btn{ width:100%; }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
  <div class="scanner-content">
    <div class="scanner-main">
      <h1 class="page-title">Barcode Scanning</h1>

      <p class="instruction-text">
        Before scanning, make sure the input field is active so the barcode is entered correctly. If the scanner doesnâ€™t respond or fails to read the code, type the barcode manually. You can scan as many as you need.
      </p>

      <!-- Barcode Overview -->
      <h2 class="section-title">Barcode Overview</h2>

      <div class="form-group">
        <label class="form-label">Scan or Enter Barcode</label>
        <div class="barcode-input-group">
          <input type="text" id="barcode-input" class="barcode-input" placeholder="Enter barcode..." autofocus>
          <button id="add-barcode" class="btn btn-primary">Add</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Scanned Barcodes</label>
        <div class="scanned-table-container">
          <table class="scanned-table">
            <thead>
              <tr>
                <th class="col-select"></th>
                <th class="col-name">Name</th>
              </tr>
            </thead>
            <tbody id="scanned-items">
              <tr id="empty-state">
                <td colspan="2" class="empty-state">
                  <div class="barcode-icon">||||</div>
                  <div class="empty-state-title">No scanned samples</div>
                  <div class="empty-state-text">This table will automatically populate with samples as they are scanned or entered manually in the input field above.</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Location -->
      <h2 class="section-title">Location</h2>

      <div class="form-group">
        <label class="form-label">Location</label>
        <select class="form-select" id="location-select">
          <option value="">-- Please Select --</option>
        </select>
      </div>

      <div class="form-group" style="margin-top:20px;">
        <label class="form-label">Sublocation</label>
        <select class="form-select" id="sublocation-select" disabled>
          <option value="">-- Please Select --</option>
        </select>
      </div>

      <!-- Actions -->
      <div class="button-group">
        <div id="update-wrapper" class="has-tooltip" data-tooltip="">
          <button id="update-button" class="btn btn-primary" disabled>Update Location</button>
        </div>
        <button id="reset-button" class="btn btn-outline">Reset</button>
      </div>

      <!-- Processing -->
      <div id="processing-status" class="processing-status">
        <div class="processing-content">
          <div class="spinner"></div>
          <span id="status-text">Processing update...</span>
        </div>
        <div class="progress-bar-container">
          <div id="progress-bar" class="progress-bar"></div>
        </div>
      </div>

      <!-- Results -->
      <div id="update-results" class="result-box">
        <h5>Update Results:</h5>
        <div id="results-content"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.tenantInfo = { tenant: "{{ tenant }}", tenantName: "{{ tenant_name }}" };
</script>
<script src="{{ url_for('static', filename='js/scanner.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const barcodeInput = document.getElementById('barcode-input');
  const addButton = document.getElementById('add-barcode');
  const scannedItems = document.getElementById('scanned-items');
  const updateWrapper = document.getElementById('update-wrapper');
  const updateButton = document.getElementById('update-button');
  const resetButton = document.getElementById('reset-button');
  const locationSelect = document.getElementById('location-select');
  const sublocationSelect = document.getElementById('sublocation-select');

  const processingBox = document.getElementById('processing-status');
  const progressBar = document.getElementById('progress-bar');
  const resultsBox = document.getElementById('update-results');
  const resultsContent = document.getElementById('results-content');

  let scannedBarcodes = [];
  let isProcessing = false;

  function showEmptyState() {
    scannedItems.innerHTML = `
      <tr id="empty-state">
        <td colspan="2" class="empty-state">
          <div class="barcode-icon">||||</div>
          <div class="empty-state-title">No scanned samples</div>
          <div class="empty-state-text">
            This table will automatically populate with samples as they are scanned or entered manually in the input field above.
          </div>
        </td>
      </tr>`;
  }

  function tooltipReason() {
    const needsBarcode = scannedBarcodes.length === 0;
    const needsLocation = !locationSelect.value;
    if (!needsBarcode && !needsLocation) return '';
    if (needsBarcode && needsLocation) return 'Add at least one barcode and choose a location';
    if (needsBarcode) return 'Add at least one barcode';
    return 'Choose a location';
  }

  function refreshUpdateState() {
    const enabled = scannedBarcodes.length > 0 && !!locationSelect.value && !isProcessing;
    updateButton.disabled = !enabled;
    updateWrapper.setAttribute('data-tooltip', enabled ? '' : tooltipReason());
  }

  function rowTemplate(barcode){
    // left cell: checkbox with actions UNDER it; right cell: barcode text
    return `
      <tr>
        <td class="td-select">
          <div class="cell-with-controls">
            <span class="checkbox" aria-hidden="true"></span>
            <div class="cell-actions">
              <button class="action-btn action-delete" title="Remove">Delete</button>
            </div>
          </div>
        </td>
        <td>${barcode}</td>
      </tr>`;
  }

  function addBarcode() {
    const barcode = barcodeInput.value.trim();
    if (!barcode || scannedBarcodes.includes(barcode)) return;

    scannedBarcodes.push(barcode);
    const empty = document.getElementById('empty-state');
    if (empty) empty.remove();

    // append row and wire delete
    const wrapper = document.createElement('tbody'); // temp wrapper to parse string
    wrapper.innerHTML = rowTemplate(barcode).trim();
    const row = wrapper.firstElementChild;
    row.querySelector('.action-delete').addEventListener('click', () => removeBarcode(barcode, row));
    scannedItems.appendChild(row);

    barcodeInput.value = '';
    barcodeInput.focus();
    refreshUpdateState();
  }

  function removeBarcode(barcode, rowEl) {
    if (isProcessing) return;
    const idx = scannedBarcodes.indexOf(barcode);
    if (idx > -1) {
      scannedBarcodes.splice(idx, 1);
      rowEl.remove();
      if (scannedBarcodes.length === 0) showEmptyState();
      refreshUpdateState();
    }
  }

  // Events
  addButton.addEventListener('click', addBarcode);
  barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') addBarcode(); });
  locationSelect.addEventListener('change', () => {
    sublocationSelect.disabled = !locationSelect.value;
    refreshUpdateState();
  });
  resetButton.addEventListener('click', () => {
    if (isProcessing) return;
    scannedBarcodes = [];
    showEmptyState();
    locationSelect.value = '';
    sublocationSelect.value = '';
    sublocationSelect.disabled = true;
    resultsBox.style.display = 'none';
    refreshUpdateState();
    barcodeInput.focus();
  });

  // (Optional) simulate update call
  updateButton.addEventListener('click', async () => {
    if (updateButton.disabled || isProcessing) return;
    isProcessing = true; refreshUpdateState();

    processingBox.style.display = 'block';
    progressBar.style.width = '0%';

    const t0 = Date.now();
    const timer = setInterval(() => {
      const pct = Math.min(95, Math.round((Date.now() - t0) / 15));
      progressBar.style.width = pct + '%';
    }, 100);

    try {
      await new Promise(r => setTimeout(r, 1000));
      clearInterval(timer);
      progressBar.style.width = '100%';
      resultsContent.innerHTML = `<strong>Success:</strong> ${scannedBarcodes.length} item(s) moved.`;
      resultsBox.style.display = 'block';
    } catch (e) {
      clearInterval(timer);
      progressBar.style.width = '0%';
      resultsContent.innerHTML = `<span style="color:#B91C1C"><strong>Error:</strong> ${e?.message || 'Update failed'}.</span>`;
      resultsBox.style.display = 'block';
    } finally {
      processingBox.style.display = 'none';
      isProcessing = false; refreshUpdateState();
    }
  });

  // init
  showEmptyState();
  refreshUpdateState();
  barcodeInput.focus();
});
</script>
{% endblock %}
