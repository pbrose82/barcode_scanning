{% extends "layout.html" %}

{% block title %}Alchemy Barcode Scanner{% endblock %}
{% set active_page = 'scanner' %}

{% block extra_css %}
<style>
  /* Base & Layout */
  html, body { 
    height: 100%; 
    background-color: #FFFFFF;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
  }
  .page-content{
    padding: 40px; 
  }

  /* Typography */
  .page-title{ 
    font-size: 24px; color: #111827; font-weight: 600; margin-bottom: 12px; 
  }
  .instruction-text{ 
    font-size: 14px; color: #4B5563; line-height: 1.6; margin-bottom: 40px; max-width: 800px;
  }
  .section-title{ 
    font-size: 20px; color: #111827; font-weight: 600; margin-bottom: 20px; 
    padding-top: 24px; border-top: 1px solid #F3F4F6;
  }
  .section-title:first-of-type {
      border-top: none; padding-top: 0;
  }
  .form-label{ 
    font-size: 12px; font-weight: 500; color: #6B7280; 
    margin-bottom: 8px; display: block; text-transform: uppercase; 
  }
  
  /* Forms & Inputs */
  .form-group { max-width: 450px; } 
  .barcode-input-group{ display:flex; gap:10px; margin-bottom: 24px; }
  .barcode-input, .form-select {
    padding: 10px 16px; font-size: 14px;
    border: 1px solid #D1D5DB; border-radius: 6px; 
  }
  .barcode-input { flex: 1; }
  .barcode-input:focus, .form-select:focus { outline: none; border-color: #2563EB; }

  .form-select{
    width: 100%; background-color: #fff;
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
  }
  /* UPDATED: Stacked location fields */
  .form-group + .form-group {
      margin-top: 20px;
  }

  /* UPDATED: Mandatory/Invalid field styles */
  .required-star { color: #EF4444; }
  .is-invalid { border-color: #EF4444 !important; }

  /* Buttons */
  .btn{ border:none; border-radius:6px; padding: 10px 24px; font-size:14px; font-weight:700; text-transform:uppercase; cursor:pointer; transition: background-color .2s, color .2s, border-color .2s; }
  .btn-primary{ background:#2563EB; color:#fff; }
  /* UPDATED: Blue outline button for Reset */
  .btn-outline {
      background-color: transparent;
      color: #2563EB;
      border: 1px solid #2563EB;
  }
  .btn-outline:hover {
      background-color: #EFF6FF;
  }
  .btn-secondary {
      background-color: #F9FAFB;
      color: #374151;
      border: 1px solid #E5E7EB;
  }
  .btn:disabled {
      background-color: #F3F4F6;
      color: #9CA3AF;
      cursor: not-allowed;
      border: 1px solid #E5E7EB;
  }


  /* Table & Hover Actions */
  .scanned-table-container{
    border: 1px solid #E5E7EB; border-radius:8px; 
    margin-top:8px; overflow:hidden; max-width: 920px;
    /* UPDATED: Table is longer */
    min-height: 250px; 
    display: flex; flex-direction: column;
  }
  .scanned-table{ width:100%; border-collapse:collapse; }
  .scanned-table thead{ 
    background: #F9FAFB; border-bottom: 1px solid #E5E7EB;
  }
  .scanned-table th {
    text-align:left; font-size:12px; font-weight: 500; color: #6B7280;
    text-transform:uppercase; padding:14px 20px;
  }
  .scanned-table td { 
    border-bottom:1px solid #E5E7EB; padding:12px 20px; font-size:14px; color: #111827;
  }
  .scanned-table tbody tr:last-child td{ border-bottom:none; }
  .scanned-table .col-actions { width: 48px; text-align: right; }

  .delete-btn {
      background: transparent; border: none; cursor: pointer;
      padding: 4px; opacity: 0; transition: opacity 0.2s ease-in-out;
  }
  .scanned-table tbody tr:hover .delete-btn { opacity: 1; }
  .delete-btn svg { width: 18px; height: 18px; fill: #9CA3AF; }
  .delete-btn:hover svg { fill: #EF4444; }


  /* Empty state */
  .empty-state{ text-align:center; padding:60px 20px; }
  .empty-state-title{ font-size:15px; font-weight:600; color:#374151; margin-bottom:8px; }

  /* Actions row */
  .button-group{ display:flex; gap:16px; margin-top: 24px; }
  
</style>
{% endblock %}

{% block content %}
<div class="page-content">
      <h1 class="page-title">Barcode Scanning</h1>
      <p class="instruction-text">
        Before scanning, make sure the input field is active so the barcode is entered correctly. In case the scanner doesnâ€™t respond or fails to read the code, you can simply type the barcode manually instead. There's no limit to how many barcodes you can scan, so feel free to continue as needed.
      </p>

      <h2 class="section-title">Barcode Overview</h2>
      <div class="form-group">
        <label class="form-label" for="barcode-input">Scan or Enter Barcode</label>
        <div class="barcode-input-group">
          <input type="text" id="barcode-input" class="barcode-input" placeholder="Enter text here" autofocus>
          <button id="add-barcode" class="btn btn-primary">Add</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Scanned Barcodes</label>
        <div class="scanned-table-container">
          <table class="scanned-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Column Name A</th>
                <th class="col-actions"></th>
              </tr>
            </thead>
            <tbody id="scanned-items">
              </tbody>
          </table>
        </div>
      </div>

      <h2 class="section-title">Location</h2>
      <div class="form-group">
          <label class="form-label" for="location-select">Location <span class="required-star">*</span></label>
          <select class="form-select is-invalid" id="location-select">
          <option value="">Please Select</option>
          </select>
      </div>
      <div class="form-group">
          <label class="form-label" for="sublocation-select">Sublocation</label>
          <select class="form-select" id="sublocation-select" disabled>
          <option value="">Please Select</option>
          </select>
      </div>

      <div class="button-group">
        <button id="update-button" class="btn btn-secondary" disabled>Update Location</button>
        <button id="reset-button" class="btn btn-outline">Reset</button>
      </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const barcodeInput = document.getElementById('barcode-input');
  const addButton = document.getElementById('add-barcode');
  const scannedItems = document.getElementById('scanned-items');
  const updateButton = document.getElementById('update-button');
  const resetButton = document.getElementById('reset-button');
  const locationSelect = document.getElementById('location-select');
  const sublocationSelect = document.getElementById('sublocation-select');
  
  let scannedBarcodes = [];

  function showEmptyState() {
    scannedItems.innerHTML = `
      <tr id="empty-state">
        <td colspan="3" class="empty-state">
          <div class="empty-state-title">No scanned samples</div>
          <div class="empty-state-text">This table will automatically populate with samples as they are scanned or entered manually in the input field above.</div>
        </td>
      </tr>`;
  }

  function removeBarcode(barcodeToRemove, rowElement) {
      const index = scannedBarcodes.indexOf(barcodeToRemove);
      if (index > -1) scannedBarcodes.splice(index, 1);
      rowElement.remove();
      if (scannedBarcodes.length === 0) showEmptyState();
      refreshUpdateState();
  }

  function addRow(barcode) {
      const rowHTML = `
        <tr data-barcode="${barcode}">
            <td>${barcode}</td>
            <td></td> 
            <td class="col-actions">
                <button class="delete-btn" title="Delete">
                    <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            </td>
        </tr>`;
      scannedItems.insertAdjacentHTML('beforeend', rowHTML);
      const newRow = scannedItems.querySelector(`tr[data-barcode="${barcode}"]`);
      const deleteBtn = newRow.querySelector('.delete-btn');
      deleteBtn.addEventListener('click', () => removeBarcode(barcode, newRow));
  }
  
  function addBarcode() {
    const barcode = barcodeInput.value.trim();
    if (!barcode || scannedBarcodes.includes(barcode)) {
        barcodeInput.value = '';
        return;
    };
    scannedBarcodes.push(barcode);
    document.getElementById('empty-state')?.remove();
    addRow(barcode);
    barcodeInput.value = '';
    barcodeInput.focus();
    refreshUpdateState();
  }
  
  function refreshUpdateState() {
    const enabled = scannedBarcodes.length > 0 && locationSelect.value !== "";
    updateButton.disabled = !enabled;
  }
  
  async function fetchLocations() {
    try {
      const response = await fetch('/api/v1/locations'); 
      if (!response.ok) throw new Error('Network response was not ok');
      const locations = await response.json();
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = location.name;
        locationSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Failed to fetch locations:', error);
    }
  }

  // --- Event Listeners ---
  addButton.addEventListener('click', addBarcode);
  barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') addBarcode(); });
  
  locationSelect.addEventListener('change', () => {
    // UPDATED: Handle validation and sublocation state
    if (locationSelect.value) {
      locationSelect.classList.remove('is-invalid');
      sublocationSelect.disabled = false;
      // Here you would typically fetch sublocations based on the selected location
    } else {
      locationSelect.classList.add('is-invalid');
      sublocationSelect.disabled = true;
      sublocationSelect.value = '';
    }
    refreshUpdateState();
  });
  
  resetButton.addEventListener('click', () => {
    scannedBarcodes = [];
    showEmptyState();
    locationSelect.value = '';
    sublocationSelect.value = '';
    sublocationSelect.disabled = true;
    locationSelect.classList.add('is-invalid'); // Reset to invalid state
    refreshUpdateState();
    barcodeInput.focus();
  });

  // --- Initialization ---
  showEmptyState();
  fetchLocations();
});
</script>
{% endblock %}
