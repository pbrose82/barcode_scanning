{% extends "layout.html" %}

{% block title %}Alchemy Barcode Scanner{% endblock %}
{% set active_page = 'scanner' %}

{% block extra_css %}
<style>
  /* Base & Layout */
  html, body { 
    height: 100%; 
    background-color: #FFFFFF; /* White page background */
    font-family: sans-serif;
  }
  .page-content{
    padding: 40px;
  }
  .scanner-content{ 
    max-width: 950px; 
    margin: 0; /* Content is aligned left, not centered */
  }

  /* Typography */
  .page-title{ 
    font-size: 28px; 
    color: #111827; /* Near-black for titles */
    font-weight: 600; 
    margin-bottom: 12px; 
  }
  .instruction-text{ 
    font-size: 14px; 
    color: #4B5563; /* Standard body text gray */
    line-height: 1.6; 
    margin-bottom: 40px; 
  }
  .section-title{ 
    font-size: 20px; 
    color: #111827; /* Near-black */
    font-weight: 600; 
    margin-bottom: 20px; 
    padding-top: 24px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .form-label{ 
    font-size: 12px; 
    font-weight: 500; /* Medium weight, not bold */
    color: #6B7280; /* Medium gray for labels */
    margin-bottom: 8px; 
    display: block; 
    text-transform: uppercase; 
  }
  
  /* Section Chevrons */
  .section-title::before {
    content: '';
    display: block;
    width: 16px;
    height: 16px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
    background-size: contain;
  }

  /* Inputs & Selects */
  .barcode-input-group{ display:flex; gap:10px; margin-bottom: 24px; }
  .barcode-input, .form-select {
    padding: 10px 16px; font-size: 14px;
    border: 1px solid #D1D5DB; /* Standard light gray border */
    border-radius: 6px; 
    transition: border-color .2s;
  }
  .barcode-input { flex: 1; }
  .barcode-input:focus, .form-select:focus { outline: none; border-color: #2563EB; }

  .form-select{
    width: 100%; background-color: #fff;
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  .form-select:disabled { background-color:#F9FAFB; cursor:not-allowed; }
  .location-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }


  /* Buttons */
  .btn{ border:none; border-radius:6px; padding: 10px 24px; font-size:14px; font-weight:700; text-transform:uppercase; cursor:pointer; transition: background-color .2s; }
  .btn-primary{ background:#2563EB; color:#fff; }
  .btn-primary:hover:not(:disabled){ background:#1D4ED8; }
  
  /* New button style for disabled/default state */
  .btn-secondary {
      background-color: #F9FAFB;
      color: #374151;
      border: 1px solid #E5E7EB;
  }
  .btn-secondary:hover {
      background-color: #F3F4F6;
  }
  .btn:disabled {
      background-color: #F3F4F6;
      color: #9CA3AF;
      cursor: not-allowed;
      border: 1px solid #E5E7EB;
  }


  /* Table */
  .scanned-table-container{
    border: 1px solid #E5E7EB;
    border-radius:8px; 
    margin-top:8px; 
    overflow:hidden; 
  }
  .scanned-table{ width:100%; border-collapse:collapse; }
  .scanned-table thead{ 
    background: #F9FAFB; /* Light gray header background */
    border-bottom: 1px solid #E5E7EB;
  }
  .scanned-table th {
    text-align:left; font-size:12px; font-weight: 500; color: #6B7280;
    text-transform:uppercase; letter-spacing:.02em; padding:14px 20px;
  }
  .scanned-table td { 
    border-bottom:1px solid #E5E7EB; 
    padding:12px 20px; font-size:14px; color: #111827; vertical-align:middle;
  }
  .scanned-table th.col-select, .scanned-table td.td-select { width: 48px; padding-left: 20px; }
  .scanned-table tbody tr:last-child td{ border-bottom:none; }
  
  /* Checkbox & Actions (logic remains the same) */
  .checkbox-input { /* Styles are fine */ }

  /* Empty state */
  .empty-state{ text-align:center; padding:60px 20px; }
  .empty-state-title{ font-size:15px; font-weight:600; color:#374151; margin-bottom:8px; }
  .empty-state-text{ font-size:14px; color:#6B7280; }

  /* Actions row */
  .button-group{ display:flex; gap:16px; margin-top: 24px; }
  
</style>
{% endblock %}

{% block content %}
<div class="page-content">
  <div class="scanner-content">
      <h1 class="page-title">Barcode Scanning</h1>
      <p class="instruction-text">
        Before scanning, make sure the input field is active so the barcode is entered correctly. In case the scanner doesnâ€™t respond or fails to read the code, you can simply type the barcode manually instead. There's no limit to how many barcodes you can scan, so feel free to continue as needed.
      </p>

      <h2 class="section-title">Barcode Overview</h2>
      <div class="form-group">
        <label class="form-label" for="barcode-input">Scan or Enter Barcode</label>
        <div class="barcode-input-group">
          <input type="text" id="barcode-input" class="barcode-input" placeholder="Enter text here" autofocus>
          <button id="add-barcode" class="btn btn-primary">Add</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Scanned Barcodes</label>
        <div class="scanned-table-container">
          <table class="scanned-table">
            <thead>
              <tr>
                <th class="col-select">
                    <input type="checkbox" id="select-all-checkbox" class="checkbox-input">
                </th>
                <th>Name</th>
                <th>Column Name A</th>
              </tr>
            </thead>
            <tbody id="scanned-items">
              </tbody>
          </table>
        </div>
      </div>

      <h2 class="section-title">Location</h2>
      <div class="location-grid">
        <div class="form-group">
            <label class="form-label" for="location-select">Location</label>
            <select class="form-select" id="location-select">
            <option value="">Please Select</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" for="sublocation-select">Sublocation</label>
            <select class="form-select" id="sublocation-select" disabled>
            <option value="">Please Select</option>
            </select>
        </div>
      </div>

      <div class="button-group">
        <button id="update-button" class="btn btn-secondary" disabled>Update Location</button>
        <button id="reset-button" class="btn btn-secondary">Reset</button>
      </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// The JavaScript logic does not need significant changes for this visual update.
// I have updated it to handle the new `colspan` and button classes.
document.addEventListener('DOMContentLoaded', function () {
  const barcodeInput = document.getElementById('barcode-input');
  const addButton = document.getElementById('add-barcode');
  const scannedItems = document.getElementById('scanned-items');
  const updateButton = document.getElementById('update-button');
  const resetButton = document.getElementById('reset-button');
  const locationSelect = document.getElementById('location-select');
  const sublocationSelect = document.getElementById('sublocation-select');
  const selectAllCheckbox = document.getElementById('select-all-checkbox');

  let scannedBarcodes = [];
  let isProcessing = false;

  function showEmptyState() {
    scannedItems.innerHTML = `
      <tr id="empty-state">
        <td colspan="3" class="empty-state">
          <div class="barcode-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7V4H20V7" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 14V17" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 14V17" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 14V17" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 14V17" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
          <div class="empty-state-title">No scanned samples</div>
          <div class="empty-state-text">This table will automatically populate with samples as they are scanned or entered manually in the input field above.</div>
        </td>
      </tr>`;
  }

  function refreshUpdateState() {
    const enabled = scannedBarcodes.length > 0 && !!locationSelect.value && !isProcessing;
    updateButton.disabled = !enabled;
  }

  function rowTemplate(barcode){
    // We only have 2 columns of data, the 3rd is for other info
    return `
      <tr data-barcode="${barcode}">
        <td class="td-select">
          <input type="checkbox" class="row-checkbox checkbox-input" data-barcode="${barcode}">
        </td>
        <td>${barcode}</td>
        <td></td> 
      </tr>`;
  }
  
  function addBarcode() {
    const barcode = barcodeInput.value.trim();
    if (!barcode || scannedBarcodes.includes(barcode)) {
        barcodeInput.value = '';
        return;
    };

    scannedBarcodes.push(barcode);
    document.getElementById('empty-state')?.remove();
    scannedItems.insertAdjacentHTML('beforeend', rowTemplate(barcode));

    barcodeInput.value = '';
    barcodeInput.focus();
    refreshUpdateState();
  }

  // Event Listeners
  addButton.addEventListener('click', addBarcode);
  barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') addBarcode(); });
  
  locationSelect.addEventListener('change', refreshUpdateState);
  
  resetButton.addEventListener('click', () => {
    if (isProcessing) return;
    scannedBarcodes = [];
    showEmptyState();
    locationSelect.value = '';
    sublocationSelect.value = '';
    sublocationSelect.disabled = true;
    refreshUpdateState();
    barcodeInput.focus();
  });

  // Initialization
  showEmptyState();
});
</script>
{% endblock %}
