{% extends "layout.html" %}

{% block title %}Alchemy Barcode Scanner{% endblock %}
{% set active_page = 'scanner' %}

{% block extra_css %}
<style>
  /* Base & Layout */
  html, body { 
    height: 100%; 
    background-color: #FFFFFF;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
  }
  .page-content{ padding: 0; }
  .page-header { background: linear-gradient(135deg, #F4F6FF 0%, #F5FBFF 100%); padding: 40px; border-bottom: 1px solid #E5E7EB; }
  .scanner-main { background-color:#FFF; padding:40px; }

  /* Typography */
  .page-title{ font-size:24px; color:#1F2937; font-weight:600; margin:0 0 12px 0; }
  .instruction-text{ font-size:14px; color:#4B5563; line-height:1.6; max-width:800px; margin:0; }
  .section-title{ font-size:24px; color:#383F45; font-weight:600; margin-bottom:20px; padding-top:24px; border-top:1px solid #F3F4F6; }
  .section-title:first-of-type{ border-top:none; padding-top:0; }
  .form-label{ font-size:12px; font-weight:700; color:#424B52; margin-bottom:8px; display:block; text-transform:capitalize; }

  /* Forms & Inputs */
  .barcode-input-group{ display:flex; gap:10px; margin-bottom:24px; align-items:center; max-width:500px; }
  .barcode-input, .form-select{
    padding:12px 16px; font-size:14px; border:1px solid #D1D5DB; border-radius:6px; height:46px; box-sizing:border-box;
  }
  .barcode-input{ flex:1; }
  .barcode-input:focus, .form-select:focus{ outline:none; border-color:#2563EB; }
  .form-select{ width:100%; background:#fff; -webkit-appearance:none; appearance:none;
    background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position:right .5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em;
  }
  .required-star{ color:#EF4444; }
  .is-invalid{ border-color:#EF4444 !important; }

  /* Buttons */
  .btn{ border:none; border-radius:6px; padding:10px 24px; font-size:14px; font-weight:700; text-transform:uppercase; cursor:pointer; }
  .btn-primary{ background:#2196F3; color:#fff; }
  .btn-outline{ background:transparent; color:#2563EB; border:1px solid #2563EB; }
  .btn-outline:hover{ background:#EFF6FF; }
  .btn-secondary{ background:#F9FAFB; color:#374151; border:1px solid #E5E7EB; }
  .btn:disabled{ background:#F3F4F6; color:#9CA3AF; cursor:not-allowed; border:1px solid #E5E7EB; }

  /* Location */
  .location-grid{ display:flex; flex-direction:column; gap:20px; max-width:450px; }

  /* === SPEC-EXACT FRAME FOR SCANNED TABLE === */
  .scanner-spec-frame{
    width:839px; height:162px; border:1px solid #E5E7EB; border-radius:8px; background:#fff;
    overflow:hidden; position:relative; box-sizing:border-box;
  }

  /* Bulk toolbar */
  #bulk-action-toolbar{
    display:none; align-items:center; gap:16px; padding:8px 20px; background:#F3F4F6; border-bottom:1px solid #E5E7EB;
  }
  #selection-count{ font-size:14px; font-weight:600; color:#374151; flex-grow:1; }
  .toolbar-btn{ display:flex; align-items:center; gap:6px; background:none; border:none; cursor:pointer; font-size:14px; font-weight:600; color:#4B5563; }
  .toolbar-btn:hover{ color:#111827; }
  .toolbar-btn svg{ width:18px; height:18px; fill:currentColor; }

  /* Table */
  .scanned-table-container{ height:100%; overflow:auto; border:0; }
  .scanned-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  .scanned-table thead{ background:#F9FAFB; border-bottom:1px solid #E5E7EB; }
  .scanned-table th, .scanned-table td{
    text-align:left; padding:14px 20px; border-bottom:1px solid #E5E7EB;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .scanned-table th{ font-size:12px; font-weight:500; color:#6B7280; text-transform:uppercase; }
  .scanned-table td{ font-size:14px; color:#111827; }
  .scanned-table tbody tr:last-child td{ border-bottom:none; }
  .scanned-table th.col-select, .scanned-table td.col-select{ width:48px; }

  /* Empty state as a row under the header (exact paddings from spec) */
  .spec-empty-cell{
    padding-top:26.5px !important; padding-right:130px !important; padding-bottom:26px !important; padding-left:20px !important;
  }
  .empty-state-title{ font-size:15px; font-weight:600; color:#374151; margin-bottom:8px; }
  .empty-state-text{ font-size:14px; color:#4B5563; }

  /* Checkbox */
  .checkbox-input{
    appearance:none; -webkit-appearance:none; width:18px; height:18px; border:1.5px solid #D1D5DB; border-radius:4px;
    background:#fff; cursor:pointer; position:relative; vertical-align:middle;
  }
  .checkbox-input:checked{ background:#2563EB; border-color:#2563EB; }
  .checkbox-input:checked::after{
    content:''; position:absolute; left:5px; top:2px; width:5px; height:10px; border:solid #fff; border-width:0 2px 2px 0; transform:rotate(45deg);
  }
  .checkbox-input:indeterminate{ background:#2563EB; border-color:#2563EB; }
  .checkbox-input:indeterminate::after{
    content:''; position:absolute; left:4px; top:7px; width:8px; height:2px; background:#fff;
  }

  .button-group{ display:flex; gap:16px; margin-top:24px; }

  /* === Spec sizing overrides === */

/* Input + Add button row should fit side-by-side: 432 + 10 gap + 72 = 514px */
.barcode-input-group { max-width: 514px; }

/* Fields: 432 × 46 */
#barcode-input { width: 432px; height: 46px; }
#location-select,
#sublocation-select {
  width: 432px;
  height: 46px;
  line-height: 46px;      /* keep text vertically centered */
}

/* Buttons: exact widths × heights */
#add-barcode {
  width: 72px;
  height: 32px;
  padding: 0;             /* remove default padding so height is exact */
  line-height: 32px;      /* vertically center label */
}

#update-button {
  width: 154px;
  height: 32px;
  padding: 0;
  line-height: 32px;
}

#reset-button {
  width: 85px;
  height: 32px;
  padding: 0;
  line-height: 32px;
}

</style>
{% endblock %}

{% block content %}
<div class="page-content">
  <div class="page-header">
    <h1 class="page-title">Barcode Scanning</h1>
    <p class="instruction-text">
      Before scanning, make sure the input field is active so the barcode is entered correctly. In case the scanner doesn’t respond or fails to read the code, you can simply type the barcode manually instead. There's no limit to how many barcodes you can scan, so feel free to continue as needed.
    </p>
  </div>

  <div class="scanner-main">
    <h2 class="section-title">Barcode Overview</h2>
    <div class="form-group">
      <label class="form-label" for="barcode-input">Scan or Enter Barcode</label>
      <div class="barcode-input-group">
        <input type="text" id="barcode-input" class="barcode-input" placeholder="Enter text here" autofocus>
        <button id="add-barcode" class="btn btn-primary">Add</button>
      </div>
    </div>

    <!-- Scanned Barcodes (header always visible) -->
    <div class="form-group">
      <label class="form-label">Scanned Barcodes</label>

      <div class="scanner-spec-frame">
        <div id="bulk-action-toolbar">
          <span id="selection-count">0 selected</span>
          <button id="bulk-delete-btn" class="toolbar-btn">
            <svg viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/>
            </svg>
            Delete
          </button>
        </div>

        <div class="scanned-table-container" id="scanned-table-wrap">
          <table class="scanned-table" id="scanned-table">
            <thead id="scanned-head">
              <tr>
                <th class="col-select">
                  <input type="checkbox" id="select-all-checkbox" class="checkbox-input">
                </th>
                <th>Name</th>
                <th>Column Name A</th>
              </tr>
            </thead>
            <tbody id="scanned-items"></tbody>
          </table>
        </div>
      </div>
    </div>

    <h2 class="section-title">Location</h2>
    <div class="location-grid">
      <div class="form-group">
        <label class="form-label" for="location-select">Location <span class="required-star">*</span></label>
        <select class="form-select is-invalid" id="location-select">
          <option value="">Please Select</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="sublocation-select">Sublocation</label>
        <select class="form-select" id="sublocation-select" disabled>
          <option value="">-- Select Sublocation --</option>
        </select>
      </div>
    </div>

    <div class="button-group">
      <button id="update-button" class="btn btn-secondary" disabled>Update Location</button>
      <button id="reset-button" class="btn btn-outline">Reset</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.tenantInfo = {
    tenant: "{{ tenant }}",
    tenantName: "{{ tenant_name }}"
  };
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const barcodeInput = document.getElementById('barcode-input');
  const addButton = document.getElementById('add-barcode');
  const scannedItems = document.getElementById('scanned-items');
  const updateButton = document.getElementById('update-button');
  const resetButton = document.getElementById('reset-button');
  const locationSelect = document.getElementById('location-select');
  const sublocationSelect = document.getElementById('sublocation-select');
  
  const bulkActionToolbar = document.getElementById('bulk-action-toolbar');
  const selectionCount = document.getElementById('selection-count');
  const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
  const selectAllCheckbox = document.getElementById('select-all-checkbox');

  let scannedBarcodes = [];
  let locationCache = [];
  const tenant = window.tenantInfo ? window.tenantInfo.tenant : null;

  /* --- Empty/Table rendering with header always visible --- */
  function renderEmptyRow() {
    scannedItems.innerHTML = `
      <tr id="empty-state-row">
        <td colspan="3" class="spec-empty-cell">
          <div class="barcode-icon">||||</div>
          <div class="empty-state-title">No scanned samples</div>
          <div class="empty-state-text">
            This table will automatically populate with samples as they are scanned or entered manually in the input field above.
          </div>
        </td>
      </tr>`;
  }

  function ensureEmptyIfNeeded() {
    if (scannedBarcodes.length === 0) renderEmptyRow();
  }

  function addRow(barcode) {
    // remove the empty-state row once we add the first record
    const emptyRow = document.getElementById('empty-state-row');
    if (emptyRow) emptyRow.remove();

    const rowHTML = `
      <tr data-barcode="${barcode}">
        <td class="col-select"><input type="checkbox" class="row-checkbox checkbox-input" data-barcode="${barcode}"></td>
        <td>${barcode}</td>
        <td></td>
      </tr>`;
    scannedItems.insertAdjacentHTML('beforeend', rowHTML);
  }
  
  function addBarcode() {
    const barcode = barcodeInput.value.trim();
    if (!barcode || scannedBarcodes.includes(barcode)) return;
    scannedBarcodes.push(barcode);
    addRow(barcode);
    barcodeInput.value = '';
    barcodeInput.focus();
    refreshUpdateState();
  }
  
  function refreshUpdateState() {
    updateButton.disabled = !(scannedBarcodes.length > 0 && locationSelect.value !== "");
  }
  
  function updateSelectionState() {
    const allCheckboxes = scannedItems.querySelectorAll('.row-checkbox');
    const checkedCheckboxes = scannedItems.querySelectorAll('.row-checkbox:checked');
    const count = checkedCheckboxes.length;

    bulkActionToolbar.style.display = count > 0 ? 'flex' : 'none';
    if (count > 0) selectionCount.textContent = `${count} selected`;

    if (allCheckboxes.length > 0 && count === allCheckboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else if (count > 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }
  }

  async function fetchLocations() {
    if (!tenant) return console.error("Tenant information is missing.");
    try {
      const response = await fetch(`/api/${tenant}/locations`); 
      if (!response.ok) throw new Error('Failed to fetch locations');
      
      const locations = await response.json();
      locationCache = locations;
      
      locationSelect.innerHTML = '<option value="">Please Select</option>';
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = location.name;
        locationSelect.appendChild(option);
      });
    } catch (error) {
      console.error(error);
    }
  }

  function populateSublocations() {
    const selectedLocationId = locationSelect.value;
    sublocationSelect.innerHTML = '<option value="">-- Select Sublocation --</option>';

    if (!selectedLocationId) {
      sublocationSelect.disabled = true;
      return;
    }
    const selectedLocation = locationCache.find(loc => loc.id == selectedLocationId);
    if (selectedLocation && selectedLocation.sublocations && selectedLocation.sublocations.length > 0) {
      selectedLocation.sublocations.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.id;
        option.textContent = sub.name;
        sublocationSelect.appendChild(option);
      });
      sublocationSelect.disabled = false;
    } else {
      sublocationSelect.disabled = true;
    }
  }
  
  // Event Listeners
  addButton.addEventListener('click', addBarcode);
  barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') addBarcode(); });
  
  locationSelect.addEventListener('change', () => {
    if (locationSelect.value) {
      locationSelect.classList.remove('is-invalid');
    } else {
      locationSelect.classList.add('is-invalid');
    }
    populateSublocations();
    refreshUpdateState();
  });
  
  resetButton.addEventListener('click', () => {
    scannedBarcodes = [];
    renderEmptyRow();
    locationSelect.value = '';
    sublocationSelect.value = '';
    sublocationSelect.disabled = true;
    locationSelect.classList.add('is-invalid');
    refreshUpdateState();
    updateSelectionState();
    barcodeInput.focus();
  });

  scannedItems.addEventListener('change', (e) => {
    if (e.target.classList.contains('row-checkbox')) updateSelectionState();
  });

  selectAllCheckbox.addEventListener('click', () => {
    scannedItems.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked);
    updateSelectionState();
  });

  bulkDeleteBtn.addEventListener('click', () => {
    scannedItems.querySelectorAll('.row-checkbox:checked').forEach(checkbox => {
      const barcode = checkbox.dataset.barcode;
      const row = checkbox.closest('tr');
      const index = scannedBarcodes.indexOf(barcode);
      if (index > -1) scannedBarcodes.splice(index, 1);
      row.remove();
    });
    if (scannedBarcodes.length === 0) renderEmptyRow();
    updateSelectionState();
    refreshUpdateState();
  });

  // Initialization
  renderEmptyRow();
  fetchLocations();
});
</script>

<!-- Main script file -->
<script src="{{ url_for('static', filename='js/scanner.js') }}"></script>
{% endblock %}
